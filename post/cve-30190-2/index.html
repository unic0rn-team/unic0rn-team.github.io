<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        CVE-2022-30190 &#34;Follina&#34; - part 2 ::
        unic0rn-team&#39;s billets — unic0rn-team&#39;s musings
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="# Billet 2 TL-DR; Suite à la publication de l&amp;quot;existence de la 0-Day, des POC (démonstrateurs) validant son exploitabilité ont commencés à apparaître rapidement. Comme pour toutes les vulnérabilités critiques, il convient de tester ceux-ci afin de valider leur exploitabilité et leur pertinence par rapport à l&amp;rsquo;environnement opérationnel.
2.POCs à surprises L&amp;rsquo;e système cible pour nos tests est un Windows 10 Professionnel x64 version 21H1 avec MS Office 2016. Pour notre banc d&amp;rsquo;essai on a décidé de choisir le démonstrateur publié par John Hammond (HuntressLab) qui a l&amp;rsquo;avantage de pouvoir tester plusieurs scénarios d&amp;rsquo;exploitation."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://unic0rn-team.github.io/post/cve-30190-2/" />





<link rel="stylesheet" href="https://unic0rn-team.github.io/assets/style.css" />

<link rel="stylesheet" href="https://unic0rn-team.github.io/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://unic0rn-team.github.io/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://unic0rn-team.github.io/img/favicon.png" />


<link href="https://unic0rn-team.github.io/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://unic0rn-team.github.io/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://unic0rn-team.github.io/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://unic0rn-team.github.io/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://unic0rn-team.github.io/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://unic0rn-team.github.io/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2022-30190 &#34;Follina&#34; - part 2"/>
<meta name="twitter:description" content="# Billet 2 TL-DR; Suite à la publication de l&quot;existence de la 0-Day, des POC (démonstrateurs) validant son exploitabilité ont commencés à apparaître rapidement. Comme pour toutes les vulnérabilités critiques, il convient de tester ceux-ci afin de valider leur exploitabilité et leur pertinence par rapport à l&rsquo;environnement opérationnel.
2.POCs à surprises L&rsquo;e système cible pour nos tests est un Windows 10 Professionnel x64 version 21H1 avec MS Office 2016. Pour notre banc d&rsquo;essai on a décidé de choisir le démonstrateur publié par John Hammond (HuntressLab) qui a l&rsquo;avantage de pouvoir tester plusieurs scénarios d&rsquo;exploitation."/>



<meta property="og:title" content="CVE-2022-30190 &#34;Follina&#34; - part 2" />
<meta property="og:description" content="# Billet 2 TL-DR; Suite à la publication de l&quot;existence de la 0-Day, des POC (démonstrateurs) validant son exploitabilité ont commencés à apparaître rapidement. Comme pour toutes les vulnérabilités critiques, il convient de tester ceux-ci afin de valider leur exploitabilité et leur pertinence par rapport à l&rsquo;environnement opérationnel.
2.POCs à surprises L&rsquo;e système cible pour nos tests est un Windows 10 Professionnel x64 version 21H1 avec MS Office 2016. Pour notre banc d&rsquo;essai on a décidé de choisir le démonstrateur publié par John Hammond (HuntressLab) qui a l&rsquo;avantage de pouvoir tester plusieurs scénarios d&rsquo;exploitation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://unic0rn-team.github.io/post/cve-30190-2/" />
<meta property="article:published_time" content="2022-07-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-01T00:00:00+00:00" /><meta property="og:site_name" content="unic0rn-team&#39;s billets" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="https://unic0rn-team.github.io/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >hello friend</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/archive">Archive</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/archive">Archive</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">CVE-2022-30190 &ldquo;Follina&rdquo; - part 2</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-07-01
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by unic0rn-team</span
        >


      
    </div>

    

    

    <div class="post-content">
      
      <h2 id="-billet-2"># Billet 2</h2>
<h3 id="tl-dr"><strong>TL-DR;</strong></h3>
<p>Suite à la publication de l&quot;existence de la 0-Day, des POC (démonstrateurs) validant son exploitabilité ont commencés à apparaître rapidement. Comme pour toutes les vulnérabilités critiques, il convient de tester ceux-ci afin de valider leur exploitabilité et leur pertinence par rapport à l&rsquo;environnement opérationnel.</p>
<h2 id="2pocs-à-surprises">2.POCs à surprises</h2>
<p>L&rsquo;e système cible pour nos tests est un Windows 10 Professionnel x64 version 21H1 avec MS Office 2016. Pour notre banc d&rsquo;essai on a décidé de choisir le démonstrateur publié par <a href="https://github.com/JohnHammond/msdt-follina">John Hammond</a> (HuntressLab) qui a l&rsquo;avantage de pouvoir tester plusieurs scénarios d&rsquo;exploitation.</p>
<h4 id="a-scénario-1-kill-chain-initial">a. Scénario 1 (kill-chain initial)</h4>
<p>Il s&rsquo;agit ici de tester la vulnérabilité tel qu&rsquo;elle à été découverte. Pour cela, le script, écrit en Python, remplace au sein du document Word porteur (&ldquo;carrier&rdquo;) la charge malveillante (&ldquo;payload&rdquo;) par l&rsquo;exécution d&rsquo;un programme inoffensif : <strong>calc.exe</strong>.  Il lancera ensuite un serveurs HTTP léger (<em>SimpleHTTPServer</em>) sur le port 8000 pour mimer le serveur C2 de l&rsquo;attaquant.</p>
<p>Son utilisation est très simple :</p>
<p><img src="/img/img9.png" alt=""></p>
<p><em><strong>Figure 1:</strong></em> <em>Utilisation basique de l&rsquo;exploit</em></p>
<p>Après avoir copié le document Word ainsi généré sur la machine cible on ouvre celui-ci. Après avoir affiché l'écran de l&rsquo;utilitaire msdt, il lancera la calculatrice :</p>
<p><img src="/img/img12.png" alt=""></p>
<p><em><strong>Figure 2:</strong></em> <em>L&rsquo;exploit exécuté</em></p>
<p>La communication avec le serveur est confirmé aussi :</p>
<p><img src="/img/img13.png" alt=""></p>
<p><em><strong>Figure 3:</strong></em> <em>Communication avec le serveur</em></p>
<p>Pour valider son comportement générique on relance le test en invoquant un autre binaire bénigne : <strong>notepad.exe</strong> avec, sans surprise, un résultat identique :</p>
<p><img src="/img/img14.png" alt=""></p>
<p><img src="/img/img15.png" alt=""></p>
<p><em><strong>Figure 4:</strong></em> <em>Execution de l&rsquo;exploit avec notepad.exe</em></p>
<p>L&rsquo;exploit etant parfaitement reproductible on confirme ainsi l&rsquo;existence de la vulnérabilité dans notre environnement. Pour tester son exploitabilité distante, le démonstrateur nous met à la disposition la possibilité d&rsquo;injecter netcat (<strong>nc.exe</strong>) et d&rsquo;invoquer ainsi un &ldquo;reverse shell&rdquo; avec la cible sur le port 9001 :</p>
<p><img src="/img/img17.png" alt=""></p>
<p><em><strong>Figure 5:</strong></em> <em>Lancer l&rsquo;exploit avec un reverse shell</em></p>
<p>Le résultat est concluant :  tandis que sur la cible s&rsquo;affiche le pop-up msdt sur le serveur de l&rsquo;attaquant on obtient un shell et on atterrit sur la machine en tant que <strong>administrateur local</strong> à la ligne de commande:</p>
<p><img src="/img/img18.png" alt=""></p>
<p><img src="/img/img19.png" alt=""></p>
<p><em><strong>Figure 6:</strong></em> <em>Acces à la machine en tant que &ldquo;ieuser&rdquo;</em></p>
<p>Il n&rsquo;est pas un hasard qu&rsquo;on ouvre la session dans le répertoire temporaire <strong>SDIAG</strong>. Ceci est liée au <a href="https://irsl.medium.com/the-trouble-with-microsofts-troubleshooters-6e32fc80b8bd">mode de création des archives</a> .cab qui contiennent les informations de dépannage en cas d&rsquo;incident : initialement  situés dans le repertoire <em>%WINDIR%\Diagnostics</em> elles sont considérés comme valides sans autre vérification, tout le reste etant soumis à la vérification de la signature. Avant de vérifier la signature, l&rsquo;implémentation du protocole msdt effectue une copie locale du répertoire référencé vers un repertoire de destination temporaire aléatoire, du type &ldquo;<em>C:\Users\John Doe\AppData\Local\Temp*<em>SDIAG</em></em>_0636db01-fabd-49ed-bd1d-b3fbbe5fd0ca*&quot;. A noter que ce chemin a un nombre statique de composants, ce qui rendra l&rsquo;attaque déterministe.</p>
<p>La criticité de la vulnérabilité vient ainsi d'être validé . Par ailleurs, après l&rsquo;application de la <a href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190">mise à jour de Microsoft</a> (ou des <a href="https://www.pwndefend.com/2022/05/30/office-microsoft-support-diagnostic-tool-msdt-vulnerability-follina/">contournements recommandés</a>) on confirme que celle-ci n&rsquo;est plus exploitable dans ce contexte.</p>
<h4 id="b-scénario-2-kill-chain-rtf"><strong>b. Scénario 2 (kill-chain RTF)</strong></h4>
<p>Dans les stages initiales de l&rsquo;analyse plusieurs chercheurs ont indiqué que l&rsquo;utilisation du mode protégé (&quot;<a href="https://support.microsoft.com/en-us/topic/what-is-protected-view-d6f09ac7-e6b9-4495-8e43-2bbcdbcb6653">Protected View</a>&quot;) de MS Office bloquerait l&rsquo;exploitation de la vulnérabilité. En voulant confirmer cela ils ont essayé de trouver des chemins d&rsquo;exécution différentes qu&rsquo;ils ont rapidement trouvé en passant du format <strong>.doc</strong> (Word) au format <strong>.rtf</strong> (Rich Text Format). Il convient donc de valider aussi ce vecteur d&rsquo;attaque.</p>
<p>Pour cela on a simplement ouvert le fichier Word généré par le démonstrateur en le sauvegardant en format RTF :</p>
<p><img src="/img/img20.png" alt=""></p>
<p><em><strong>Figure 7:</strong></em> <em>Changer le format du document</em> ***Figure</p>
<p>On met notre serveur à l'écoute comme pour le premier scénario :</p>
<p><img src="/img/img21.png" alt=""></p>
<p><em><strong>Figure 8:</strong></em> <em>Relancement de l&rsquo;exploit sur le port 8000</em></p>
<p>Dans le répertoire ou se trouve notre fichier .rtf on active le paneau de previsualisation et on choisit le fichier sans l&rsquo;ouvrir :</p>
<p><img src="/img/img22.png" alt=""></p>
<p><em><strong>Figure 9:</strong></em> <em>Activer la previsualisation</em></p>
<p><img src="/img/img23.png" alt=""></p>
<p><em><strong>Figure 10:</strong></em> <em>Selectionner le fichier</em></p>
<p>Contre toute attente, on remarque une requète sur le serveur et la charge est, encore une fois exécutée :</p>
<p><img src="/img/img25.png" alt=""></p>
<p><img src="/img/img24.png" alt=""></p>
<p><em><strong>Figure 11:</strong></em> <em>Exploit réussi</em></p>
<p>Quelles sont les conséquences de l&rsquo;abus de ce noveau vecteur d&rsquo;attaque ? En principal :</p>
<ul>
<li>l&rsquo;exécution distante du code en 1-click (&ldquo;1-click RCE&rdquo;) se tranforme en une <strong>exécution distante en 0-click</strong> (&ldquo;O-click RCE&rdquo;) donc sans intervention de la victime</li>
<li>on s&rsquo;affranchit de exécution avec des <strong>composants MS Office</strong> - la vulnérabilité devenant ainsi générique</li>
<li>le correctif publié par Microsoft n&rsquo;adresse pas ce vecteur d&rsquo;attaque - en effet, à l&rsquo;heure actuelle, il n&rsquo;y a <strong>pas de patch publié</strong>, alors que plusieurs échantillons d&rsquo;exploitation réele (ITW) sont déjà disponibles</li>
</ul>
<p>Pour comprendre le méchanisme d&rsquo;exploitation on a, justement, récupéré un de ces fichiers RTF disponibles : <strong>aaa.rtf</strong> (<a href="https://www.virustotal.com/gui/file/e8f0a2f79a91587f1d961d6668792e74985624d652c7b47cc87367cb1b451adf/detection">e8f0a2f79a91587f1d961d6668792e74985624d652c7b47cc87367cb1b451adf</a>).</p>
<p>Le format de fichier RTF à été très souvent exploité auparavant, en abusant sa fonctionnalité de conteneur qui peut intégrer d&rsquo;autres fichiers à l&rsquo;aide de la fonction <strong>OLE</strong> (&ldquo;Object Linking and Embedding&rdquo;)  -liaison et d&rsquo;intégration d&rsquo;objets - utilisé pour armer ce type de documents. Les documents RTF sont donc connus pour diffuser des logiciels malveillants en intégrant des scripts via des objets OLE, puis en utilisant des schémas de nommage intélligente (&quot;<strong>monikers</strong>&quot;) pour déposer des fichiers dans le répertoire souhaité, puis les exécuter.</p>
<p>Les monikers (sobriquets) sont une façon standardisé et extensible de nommer et connecter des objets entre eux. Plus simplement un moniker est un objet qui identifie un autre objet. Si notre fichier contienne des liens vers un objet externe l&rsquo;<strong>URLMoniker</strong> doit être présent pour l&rsquo;instantialiser. Notre tâche consiste donc en sa mise en évidence.</p>
<p>On commence par visualiser la structure du document ou on trouve immédiatement un objet qui contient un URL :</p>
<p><img src="/img/img32.png" alt=""></p>
<p><img src="/img/img33.png" alt=""></p>
<p><em><strong>Figure 12:</strong></em> *<em>\objcall contenant un URL</em></p>
<p>L&rsquo;URL en question : hxxp://109.248.59.74/a.html pointe vers une adresse IP en Russie.</p>
<p><img src="/img/img34.png" alt=""></p>
<p>Si on veut voir l&rsquo;ensemble des objets intégrés dans le fichier :</p>
<p><img src="/img/img35.png" alt=""></p>
<p><em><strong>Figure 13:</strong></em> <em>Liste des objets embarques</em></p>
<p>On isole le premier objet (OLE2Link) - tous les objets intégrés sont représentés au format OLE2- qui contienne trois streams :</p>
<p><img src="/img/img36.png" alt=""></p>
<p><img src="/img/img37.png" alt=""></p>
<p><img src="/img/img38.png" alt=""></p>
<p><em><strong>Figure14:</strong></em> <em>Contenu du premier objet</em></p>
<p>Seulement les deux premiers embarquent l&rsquo;URL ( les streams peuvent être isoles par la suite ):</p>
<p><img src="/img/img39.png" alt=""></p>
<p><em><strong>Figure 15:</strong></em> <em>Contenu du premier stream</em></p>
<p><img src="/img/img40.png" alt=""></p>
<p><em><strong>Figure 16:</strong></em> <em>Contenu du deuxième stream</em></p>
<p><img src="/img/img41.png" alt=""></p>
<p><em><strong>Figure 17:</strong></em> <em>Extraction de tous les URLs</em></p>
<p>Chaque objet <a href="https://danusminimus.github.io/2022/06/18/Understanding-OLE-Objects-and-Microsoft-Magic-to-mess-with-with-CVE-2022-30190(Follina).html">OLE incorporé</a> dans un fichier RTF est enregistré dans la base de registres avec son identificateur de classe (Class ID - <strong>CLSID</strong> - identificateur unique pour tout composant Windows). En pratique toute entrée dans la base de régistres pour un composant se trouve d&rsquo;habitude stocké dans la clef HKEY_CLASSES_ROOT\CLSID\{valeur CLSID}.</p>
<p>Cela veut dire qu&quot;en récupérent la valeur CLSID de notre objet on peut identifié l&rsquo;URL Moniker associé :</p>
<p><img src="/img/img42.png" alt=""></p>
<p><em><strong>Figure 18:</strong></em> <em>Identification d&rsquo;URL Moniker</em></p>
<p>On peut donc envisager comme mécanisme le plus probable d&rsquo;exécution l&rsquo;enchaînement suivant :</p>
<p>A l&rsquo;activation du document RTF en le sélectionnant dans le panneau de prévisualisation, l&rsquo;<a href="https://docs.microsoft.com/en-us/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject">URL Moniker</a> instantialise (à travers <strong>urlmon.dll</strong> qui est son serveur enregistré) l&rsquo;objet COM et la connexion est établie avec la ressource externe. Les détails sur la façon dont URL Moniker est exécuté et un algorithme pour déterminer les gestionnaires de protocole appropriés à invoquer (dans notre cas ms-msdt) sont décrits par <a href="https://docs.microsoft.com/en-us/windows/win32/api/objidl/nf-objidl-imoniker-bindtoobject">Microsoft</a>. Faute de contrôles en place le fichier <strong>a.html</strong> est ainsi téléchargé et le code executé par le moteur <strong>explorer.exe</strong> dans la deuxième étape du kill-chain.</p>
<h3 id="c-scénario-3-kill-chain-wget"><strong>c. Scénario 3 (kill-chain wget)</strong></h3>
<p>L&rsquo;analyse de l&rsquo;exploit initial à mis en évidence le fait que la deuxième étape de l&rsquo;attaque (second stage) est déclenché en mémoire par une commande PowerShell obfusqué en base64. La question de savoir si on ne peut pas récupérer et faire exécuter directement le fichier html sans passer par un porteur (carrier) tel que Word or RTF avec l&rsquo;aide du PowerShell s&rsquo;est donc vite posée.</p>
<p>Pour tester cette hypothèse on a crée un fichier <strong>index.html</strong> qui contient l&rsquo;exploit  initial, comme suit :</p>
<p><img src="/img/img27.png" alt=""></p>
<p><em><strong>Figure 19:</strong></em> <em>Contenu du fichier index.html de test</em></p>
<p>On a positionné celui-ci a la racine du serveur HTTP utilisé pour le démonstrateur qu&rsquo;on à lancé sur le port 8000 :</p>
<p><img src="/img/img28.png" alt=""></p>
<p><em><strong>Figure 20:</strong></em> <em>Lancement du serveur</em></p>
<p>Sur la machine &ldquo;victime&rdquo; dans une console PowerShell on à utilisé wget pour le récupérer :</p>
<p><img src="/img/img29.png" alt=""></p>
<p><em><strong>Figure 21:</strong></em> <em>Tentative de téléchargement du fichier index.html</em></p>
<p>Etonnamment la charge est exécute sans intervention et la calculatrice est lancée :</p>
<p><img src="/img/img30.png" alt=""></p>
<p><em><strong>Figure 22:</strong></em> <em>Validation du demonstrateur</em></p>
<p>Ceci est un comportement anormal, car wget est censé simplement télécharger le fichier et pas l&rsquo;executer.</p>
<p>Tous ces testes confirment à la fois la criticié réele de cette vulnérabilité mais aussi la fragilité de l&rsquo;ecosystème logiciel sous Windows.</p>
<p><img src="/img/img43.png" alt=""></p>
<p>A suivre&hellip;</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://unic0rn-team.github.io/post/cve-30190-1/">
                  <span class="button__icon">←</span>
                  <span class="button__text">CVE-2022-30190 &#34;Follina&#34; - part 1</span>
                </a>
              </span>
            
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="https://unic0rn-team.github.io/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >hello friend</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2023 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="https://unic0rn-team.github.io/assets/main.js"></script>
<script src="https://unic0rn-team.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
